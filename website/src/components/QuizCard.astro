---
interface Props {
  quizId: string;
  title: string;
  description: string;
  questionCount: number;
  href: string;
}

const { quizId, title, description, questionCount, href } = Astro.props;
---

<a class="quiz-card" href={href} data-quiz-id={quizId}>
  <div class="quiz-card-body">
    <h3 class="quiz-card-title">{title}</h3>
    <p class="quiz-card-desc">{description}</p>
    <p class="quiz-card-count">{questionCount} questions</p>
  </div>
  <div class="quiz-card-status" data-status-id={quizId}>
    <span class="quiz-card-badge quiz-card-badge-new">Non commenc√©</span>
  </div>
</a>

<script>
  import { getQuizResult } from '../utils/quizStorage';

  function updateCards() {
    document.querySelectorAll<HTMLElement>('[data-status-id]').forEach((el) => {
      const quizId = el.dataset.statusId;
      if (!quizId) return;
      const result = getQuizResult(quizId);
      if (!result) return;

      const percent = Math.round((result.score / result.total) * 100);
      const date = new Date(result.date).toLocaleDateString('fr-FR');
      const pass = percent >= 60;

      // Color the card border
      const card = el.closest<HTMLElement>('.quiz-card');
      if (card) {
        card.classList.add(pass ? 'quiz-card-done-pass' : 'quiz-card-done-fail');
      }

      // Render circular score + date
      const circumference = 2 * Math.PI * 18;
      const offset = circumference - (percent / 100) * circumference;
      const color = pass ? '#16a34a' : '#f59e0b';

      el.innerHTML = `
        <div class="quiz-card-score-ring">
          <svg width="48" height="48" viewBox="0 0 48 48">
            <circle cx="24" cy="24" r="18" fill="none" stroke="var(--sl-color-gray-6)" stroke-width="4"/>
            <circle cx="24" cy="24" r="18" fill="none" stroke="${color}" stroke-width="4"
              stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
              stroke-linecap="round" transform="rotate(-90 24 24)"/>
          </svg>
          <span class="quiz-card-score-percent" style="color: ${color}">${percent}%</span>
        </div>
        <span class="quiz-card-score-detail">${result.score}/${result.total}</span>
        <span class="quiz-card-date">${date}</span>
      `;
    });
  }

  // Ensure DOM is ready before updating cards
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateCards);
  } else {
    updateCards();
  }
</script>

<style>
  .quiz-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    padding: 1.2rem 1.5rem;
    border: 2px solid var(--sl-color-gray-5);
    border-radius: 10px;
    text-decoration: none;
    color: var(--sl-color-text);
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .quiz-card:hover {
    border-color: var(--sl-color-accent);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .quiz-card:global(.quiz-card-done-pass) {
    border-color: rgba(22, 163, 74, 0.4);
  }

  .quiz-card:global(.quiz-card-done-pass):hover {
    border-color: #16a34a;
  }

  .quiz-card:global(.quiz-card-done-fail) {
    border-color: rgba(245, 158, 11, 0.4);
  }

  .quiz-card:global(.quiz-card-done-fail):hover {
    border-color: #f59e0b;
  }

  .quiz-card-body {
    flex: 1;
    min-width: 0;
  }

  .quiz-card-title {
    margin: 0 0 0.3rem;
    font-size: 1.05rem;
  }

  .quiz-card-desc {
    margin: 0 0 0.4rem;
    font-size: 0.9rem;
    color: var(--sl-color-gray-3);
  }

  .quiz-card-count {
    margin: 0;
    font-size: 0.85rem;
    color: var(--sl-color-gray-4);
  }

  .quiz-card-status {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.2rem;
    flex-shrink: 0;
  }

  .quiz-card-badge {
    display: inline-block;
    padding: 0.25rem 0.7rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .quiz-card-badge-new {
    background: var(--sl-color-gray-6);
    color: var(--sl-color-gray-2);
  }

  .quiz-card-score-ring {
    position: relative;
    width: 48px;
    height: 48px;
  }

  .quiz-card-score-ring :global(svg) {
    display: block;
  }

  .quiz-card-score-percent {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 700;
  }

  .quiz-card-score-detail {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--sl-color-text);
  }

  .quiz-card-date {
    font-size: 0.7rem;
    color: var(--sl-color-gray-4);
  }
</style>
