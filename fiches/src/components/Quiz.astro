---
interface Props {
  quizData: string;
}

const { quizData } = Astro.props;
---

<div class="quiz-container" id="quiz-root" data-quiz={quizData}>
  <div class="quiz-header" id="quiz-header">
    <div class="quiz-header-info">
      <span class="quiz-counter" id="quiz-counter"></span>
      <span class="quiz-score-live" id="quiz-score-live"></span>
    </div>
    <div class="quiz-progress-bar">
      <div class="quiz-progress-fill" id="quiz-progress-fill"></div>
    </div>
  </div>

  <div class="quiz-card" id="quiz-card">
    <h2 class="quiz-question-text" id="quiz-question-text" tabindex="-1"></h2>
    <div class="quiz-options" id="quiz-options"></div>
    <div class="quiz-feedback" id="quiz-feedback" aria-live="polite" aria-atomic="true"></div>
    <div class="quiz-nav">
      <button class="quiz-btn quiz-btn-ghost" id="quiz-prev" type="button">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M10 12L6 8l4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Précédent
      </button>
      <button class="quiz-btn quiz-btn-primary" id="quiz-validate" type="button">Valider</button>
      <button class="quiz-btn quiz-btn-primary" id="quiz-next" type="button" style="display:none">
        Suivant
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>

  <div class="quiz-result" id="quiz-result" style="display:none">
    <div class="quiz-result-card">
      <div class="quiz-result-circle">
        <svg viewBox="0 0 120 120" class="quiz-result-svg">
          <circle cx="60" cy="60" r="54" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8"/>
          <circle cx="60" cy="60" r="54" fill="none" stroke-width="8" stroke-linecap="round" id="quiz-result-arc"
            stroke-dasharray="339.29" stroke-dashoffset="339.29" transform="rotate(-90 60 60)"/>
        </svg>
        <div class="quiz-result-percent" id="quiz-result-percent"></div>
      </div>
      <h2 class="quiz-result-title" id="quiz-result-title"></h2>
      <p class="quiz-result-detail" id="quiz-result-detail"></p>
      <div class="quiz-result-actions">
        <button class="quiz-btn quiz-btn-primary" id="quiz-retry" type="button">Recommencer</button>
        <a class="quiz-btn quiz-btn-ghost" href="/quiz/">Tous les quiz</a>
      </div>
    </div>
  </div>
</div>

<script>
  import { saveQuizResult, saveQuizProgress, getQuizProgress } from '../utils/quizStorage';

  function initQuiz() {
    const rootEl = document.getElementById('quiz-root');
    if (!rootEl?.dataset.quiz) return;

    const quiz = JSON.parse(rootEl.dataset.quiz);
    const questions = quiz.questions;
    const totalQuestions = questions.length;

    const savedProgress = getQuizProgress(quiz.id);
    let currentIndex = savedProgress?.currentIndex ?? 0;
    let answers: (number | null)[] = savedProgress?.answers ?? new Array(totalQuestions).fill(null);
    let validated: boolean[] = savedProgress?.validated ?? new Array(totalQuestions).fill(false);

    if (answers.length !== totalQuestions) {
      currentIndex = 0;
      answers = new Array(totalQuestions).fill(null);
      validated = new Array(totalQuestions).fill(false);
    }

    const counter = document.getElementById('quiz-counter')!;
    const scoreLive = document.getElementById('quiz-score-live')!;
    const progressFill = document.getElementById('quiz-progress-fill')!;
    const questionText = document.getElementById('quiz-question-text')!;
    const optionsContainer = document.getElementById('quiz-options')!;
    const feedback = document.getElementById('quiz-feedback')!;
    const prevBtn = document.getElementById('quiz-prev') as HTMLButtonElement;
    const validateBtn = document.getElementById('quiz-validate') as HTMLButtonElement;
    const nextBtn = document.getElementById('quiz-next') as HTMLButtonElement;
    const quizCard = document.getElementById('quiz-card')!;
    const resultArea = document.getElementById('quiz-result')!;
    const headerEl = document.getElementById('quiz-header')!;
    const retryBtn = document.getElementById('quiz-retry') as HTMLButtonElement;

    function persistProgress() {
      saveQuizProgress(quiz.id, currentIndex, answers, validated);
    }

    function getLiveScore(): { correct: number; answered: number } {
      let correct = 0;
      let answered = 0;
      for (let i = 0; i < totalQuestions; i++) {
        if (validated[i]) {
          answered++;
          if (answers[i] === questions[i].correctAnswer) correct++;
        }
      }
      return { correct, answered };
    }

    function renderQuestion() {
      const q = questions[currentIndex];
      counter.textContent = `Question ${currentIndex + 1} / ${totalQuestions}`;
      progressFill.style.width = `${((currentIndex + 1) / totalQuestions) * 100}%`;

      const { correct, answered } = getLiveScore();
      scoreLive.textContent = answered > 0 ? `${correct} / ${answered} correct` : '';

      questionText.textContent = q.question;

      optionsContainer.innerHTML = '';
      q.options.forEach((option: string, i: number) => {
        const el = document.createElement('div');
        el.className = 'q-option';
        el.setAttribute('role', 'radio');
        el.setAttribute('aria-checked', String(answers[currentIndex] === i));

        if (validated[currentIndex]) el.classList.add('q-locked');
        if (answers[currentIndex] === i) el.classList.add('q-selected');

        const indicator = document.createElement('span');
        indicator.className = 'q-indicator';

        if (validated[currentIndex] && i === q.correctAnswer) {
          el.classList.add('q-correct');
          indicator.innerHTML = '<svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M3 8l3.5 3.5L13 5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        } else if (validated[currentIndex] && i === answers[currentIndex]) {
          el.classList.add('q-wrong');
          indicator.innerHTML = '<svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/></svg>';
        } else {
          indicator.textContent = String.fromCharCode(65 + i);
        }

        const text = document.createElement('span');
        text.className = 'q-text';
        text.textContent = option;

        el.appendChild(indicator);
        el.appendChild(text);
        optionsContainer.appendChild(el);

        if (!validated[currentIndex]) {
          el.addEventListener('click', () => {
            answers[currentIndex] = i;
            optionsContainer.querySelectorAll('.q-option').forEach((opt, idx) => {
              opt.classList.toggle('q-selected', idx === i);
              opt.setAttribute('aria-checked', String(idx === i));
            });
          });
        }
      });

      if (validated[currentIndex]) {
        const isCorrect = answers[currentIndex] === q.correctAnswer;
        feedback.innerHTML = `<div class="q-feedback ${isCorrect ? 'q-fb-correct' : 'q-fb-wrong'}">
          <span class="q-fb-icon">${isCorrect ? '\u2713' : '\u2717'}</span>
          <div>
            <strong>${isCorrect ? 'Bonne r\u00e9ponse !' : 'Mauvaise r\u00e9ponse'}</strong>
            <p>${q.explanation}</p>
          </div>
        </div>`;
        validateBtn.style.display = 'none';
        nextBtn.style.display = '';
      } else {
        feedback.innerHTML = '';
        validateBtn.style.display = '';
        nextBtn.style.display = 'none';
      }

      prevBtn.disabled = currentIndex === 0;

      if (validated[currentIndex] && currentIndex === totalQuestions - 1) {
        nextBtn.innerHTML = 'Voir le r\u00e9sultat <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      } else {
        nextBtn.innerHTML = 'Suivant <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      }
    }

    validateBtn.addEventListener('click', () => {
      if (answers[currentIndex] === null) {
        feedback.innerHTML = '<div class="q-feedback q-fb-warn"><span class="q-fb-icon">!</span><div>Veuillez s\u00e9lectionner une r\u00e9ponse.</div></div>';
        return;
      }
      validated[currentIndex] = true;
      persistProgress();
      renderQuestion();
    });

    nextBtn.addEventListener('click', () => {
      if (currentIndex < totalQuestions - 1) {
        currentIndex++;
        persistProgress();
        renderQuestion();
        questionText.focus();
      } else {
        showScore();
      }
    });

    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        persistProgress();
        renderQuestion();
        questionText.focus();
      }
    });

    function showScore() {
      const { correct } = getLiveScore();
      const percent = Math.round((correct / totalQuestions) * 100);

      saveQuizResult(quiz.id, correct, totalQuestions);

      quizCard.style.display = 'none';
      headerEl.style.display = 'none';
      resultArea.style.display = '';

      const arc = document.getElementById('quiz-result-arc')!;
      const circumference = 339.29;
      const offset = circumference - (circumference * percent) / 100;

      let color: string;
      if (percent >= 80) color = '#22c55e';
      else if (percent >= 60) color = '#3b82f6';
      else if (percent >= 40) color = '#eab308';
      else color = '#ef4444';

      arc.style.stroke = color;
      requestAnimationFrame(() => {
        arc.style.transition = 'stroke-dashoffset 1s ease';
        arc.style.strokeDashoffset = String(offset);
      });

      const percentEl = document.getElementById('quiz-result-percent')!;
      percentEl.textContent = `${percent}%`;
      percentEl.style.color = color;

      const titleEl = document.getElementById('quiz-result-title')!;
      if (percent >= 80) titleEl.textContent = 'Excellent !';
      else if (percent >= 60) titleEl.textContent = 'Bien !';
      else if (percent >= 40) titleEl.textContent = 'Peut mieux faire';
      else titleEl.textContent = 'Continuez vos efforts';

      document.getElementById('quiz-result-detail')!.textContent =
        `${correct} bonne${correct > 1 ? 's' : ''} r\u00e9ponse${correct > 1 ? 's' : ''} sur ${totalQuestions}`;
    }

    retryBtn.addEventListener('click', () => {
      currentIndex = 0;
      answers = new Array(totalQuestions).fill(null);
      validated = new Array(totalQuestions).fill(false);
      persistProgress();
      quizCard.style.display = '';
      headerEl.style.display = '';
      resultArea.style.display = 'none';
      const arc = document.getElementById('quiz-result-arc')!;
      arc.style.transition = 'none';
      arc.style.strokeDashoffset = '339.29';
      renderQuestion();
    });

    renderQuestion();
  }

  initQuiz();
</script>

<style is:global>
  .quiz-container {
    max-width: 720px;
    margin: 0 auto;
  }

  /* Header */
  .quiz-header {
    margin-bottom: 1.25rem;
  }

  .quiz-header-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .quiz-counter {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--sl-color-white);
  }

  .quiz-score-live {
    font-size: 0.8rem;
    color: var(--sl-color-gray-3);
  }

  /* Progress bar */
  .quiz-progress-bar {
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    overflow: hidden;
  }

  [data-theme='light'] .quiz-progress-bar {
    background: rgba(0, 0, 0, 0.08);
  }

  .quiz-progress-fill {
    height: 100%;
    background: var(--sl-color-accent);
    border-radius: 3px;
    transition: width 0.3s ease;
  }

  /* Card */
  .quiz-card {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 2rem;
  }

  [data-theme='light'] .quiz-card {
    background: rgba(0, 0, 0, 0.02);
    border-color: rgba(0, 0, 0, 0.1);
  }

  .quiz-question-text {
    font-size: 1.15rem;
    font-weight: 600;
    line-height: 1.6;
    margin: 0 0 1.5rem;
  }

  .quiz-question-text:focus {
    outline: none;
  }

  /* Options — using global classes for dynamic elements */
  .quiz-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin: 0 0 1rem;
  }

  .q-option {
    display: flex;
    align-items: center;
    gap: 0.85rem;
    padding: 0.85rem 1rem;
    border: 2px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
    background: transparent;
    user-select: none;
  }

  [data-theme='light'] .q-option {
    border-color: rgba(0, 0, 0, 0.12);
  }

  .q-option:hover:not(.q-locked) {
    border-color: var(--sl-color-accent);
    background: rgba(99, 102, 241, 0.06);
  }

  .q-option.q-selected:not(.q-locked) {
    border-color: var(--sl-color-accent);
    background: rgba(99, 102, 241, 0.1);
  }

  .q-option.q-locked {
    cursor: default;
  }

  .q-option.q-correct {
    border-color: #22c55e !important;
    background: rgba(34, 197, 94, 0.1) !important;
  }

  .q-option.q-wrong {
    border-color: #ef4444 !important;
    background: rgba(239, 68, 68, 0.08) !important;
  }

  .q-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    font-size: 0.8rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.7);
    flex-shrink: 0;
    transition: background 0.15s, color 0.15s;
  }

  [data-theme='light'] .q-indicator {
    background: rgba(0, 0, 0, 0.07);
    color: rgba(0, 0, 0, 0.55);
  }

  .q-option.q-selected:not(.q-locked) .q-indicator {
    background: var(--sl-color-accent);
    color: #fff;
  }

  .q-option.q-correct .q-indicator {
    background: #22c55e !important;
    color: #fff !important;
  }

  .q-option.q-wrong .q-indicator {
    background: #ef4444 !important;
    color: #fff !important;
  }

  .q-text {
    line-height: 1.4;
    font-size: 0.95rem;
  }

  /* Feedback */
  .quiz-feedback {
    min-height: 1rem;
    margin-bottom: 1rem;
  }

  .q-feedback {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    padding: 1rem 1.25rem;
    border-radius: 12px;
  }

  .q-feedback p {
    margin: 0.35rem 0 0;
    font-size: 0.9rem;
    line-height: 1.5;
    opacity: 0.9;
  }

  .q-fb-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 26px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    font-size: 0.85rem;
    font-weight: 700;
    flex-shrink: 0;
  }

  .q-fb-correct {
    background: rgba(34, 197, 94, 0.12);
  }

  .q-fb-correct .q-fb-icon {
    background: #22c55e;
    color: #fff;
  }

  .q-fb-wrong {
    background: rgba(239, 68, 68, 0.1);
  }

  .q-fb-wrong .q-fb-icon {
    background: #ef4444;
    color: #fff;
  }

  .q-fb-warn {
    background: rgba(234, 179, 8, 0.1);
  }

  .q-fb-warn .q-fb-icon {
    background: #eab308;
    color: #fff;
  }

  /* Nav */
  .quiz-nav {
    display: flex;
    gap: 0.75rem;
    justify-content: space-between;
  }

  .quiz-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.65rem 1.25rem;
    border-radius: 10px;
    border: none;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .quiz-btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .quiz-btn-primary {
    background: var(--sl-color-accent);
    color: var(--sl-color-accent-contrast, #fff);
  }

  .quiz-btn-primary:hover:not(:disabled) {
    filter: brightness(1.1);
  }

  .quiz-btn-ghost {
    background: transparent;
    color: var(--sl-color-white);
  }

  .quiz-btn-ghost:hover:not(:disabled) {
    background: rgba(255, 255, 255, 0.08);
  }

  [data-theme='light'] .quiz-btn-ghost {
    color: var(--sl-color-black);
  }

  [data-theme='light'] .quiz-btn-ghost:hover:not(:disabled) {
    background: rgba(0, 0, 0, 0.06);
  }

  /* Result */
  .quiz-result {
    padding: 1rem 0;
  }

  .quiz-result-card {
    text-align: center;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 2.5rem 2rem;
  }

  [data-theme='light'] .quiz-result-card {
    background: rgba(0, 0, 0, 0.02);
    border-color: rgba(0, 0, 0, 0.1);
  }

  .quiz-result-circle {
    position: relative;
    width: 140px;
    height: 140px;
    margin: 0 auto 1.5rem;
  }

  .quiz-result-svg {
    width: 100%;
    height: 100%;
  }

  .quiz-result-percent {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    font-weight: 800;
  }

  .quiz-result-title {
    font-size: 1.5rem;
    margin: 0 0 0.5rem;
  }

  .quiz-result-detail {
    font-size: 1rem;
    color: var(--sl-color-gray-3);
    margin: 0 0 2rem;
  }

  .quiz-result-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  @media (max-width: 480px) {
    .quiz-card {
      padding: 1.25rem;
    }

    .quiz-question-text {
      font-size: 1.05rem;
    }
  }
</style>
